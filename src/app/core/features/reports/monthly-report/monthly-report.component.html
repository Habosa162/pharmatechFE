<!-- monthly-report.component.html -->
<div class="report-page">

  <!-- ‚îÄ‚îÄ Page Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="report-header d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h2 class="report-title mb-0">
        <span class="report-title-icon">üìä</span>
        Monthly Report
      </h2>
      <p class="text-muted small mb-0" *ngIf="report">
        {{ report.clinicName }} &mdash; Generated {{ formatDate(report.generatedAt) }}
      </p>
    </div>

    <!-- Controls -->
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <select class="form-select form-select-sm report-select" [(ngModel)]="selectedMonth">
        <option *ngFor="let m of months" [value]="m.value">{{ m.label }}</option>
      </select>

      <select class="form-select form-select-sm report-select" [(ngModel)]="selectedYear">
        <option *ngFor="let y of years" [value]="y">{{ y }}</option>
      </select>

      <button class="btn btn-primary btn-sm px-3"
              (click)="loadReport()"
              [disabled]="isLoadingData">
        <span *ngIf="!isLoadingData">
          <i class="bi bi-search me-1"></i> Generate
        </span>
        <span *ngIf="isLoadingData">
          <span class="spinner-border spinner-border-sm me-1"></span> Loading...
        </span>
      </button>

      <button class="btn btn-outline-danger btn-sm px-3"
              (click)="exportPdf()"
              [disabled]="isExporting || !report">
        <span *ngIf="!isExporting">
          <i class="bi bi-file-earmark-pdf me-1"></i> PDF
        </span>
        <span *ngIf="isExporting">
          <span class="spinner-border spinner-border-sm me-1"></span> Exporting...
        </span>
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Error ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div *ngIf="errorMessage" class="alert alert-danger d-flex align-items-center gap-2">
    <i class="bi bi-exclamation-triangle-fill"></i>
    {{ errorMessage }}
    <button class="btn-close ms-auto" (click)="errorMessage = null"></button>
  </div>

  <!-- ‚îÄ‚îÄ Skeleton Loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div *ngIf="isLoadingData" class="row g-3">
    <div class="col-md-4" *ngFor="let _ of [1,2,3]">
      <div class="skeleton-card"></div>
    </div>
    <div class="col-12">
      <div class="skeleton-card tall"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <ng-container *ngIf="report && !isLoadingData">

    <!-- Period badge -->
    <div class="period-badge mb-4">
      <span class="badge-dot"></span>
      Report period: <strong>{{ monthLabel }} {{ selectedYear }}</strong>
    </div>

    <!-- ‚îÄ‚îÄ KPI Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="row g-3 mb-4">

      <div class="col-sm-6 col-xl-3">
        <div class="kpi-card kpi-income">
          <div class="kpi-label">Total Income</div>
          <div class="kpi-value">{{ formatCurrency(report.financial.totalIncome) }}</div>
          <div class="kpi-sub">This month's revenue</div>
        </div>
      </div>

      <div class="col-sm-6 col-xl-3">
        <div class="kpi-card kpi-expense">
          <div class="kpi-label">Total Expenses</div>
          <div class="kpi-value">{{ formatCurrency(report.financial.totalExpenses) }}</div>
          <div class="kpi-sub">This month's costs</div>
        </div>
      </div>

      <div class="col-sm-6 col-xl-3">
        <div class="kpi-card" [ngClass]="report.financial.netProfit >= 0 ? 'kpi-profit' : 'kpi-loss'">
          <div class="kpi-label">Net Profit / Loss</div>
          <div class="kpi-value">
            {{ netProfitIcon }} {{ formatCurrency(report.financial.netProfit) }}
          </div>
          <div class="kpi-sub">Income minus expenses</div>
        </div>
      </div>

      <div class="col-sm-6 col-xl-3">
        <div class="kpi-card kpi-invoices">
          <div class="kpi-label">Total Invoices</div>
          <div class="kpi-value">{{ report.financial.invoiceSummary.totalInvoices }}</div>
          <div class="kpi-sub">{{ formatCurrency(report.financial.invoiceSummary.totalInvoiceAmount) }} billed</div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ Financial Details Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="row g-3 mb-4">

      <!-- Income Categories -->
      <div class="col-lg-6">
        <div class="report-card h-100">
          <div class="report-card-header income-header">
            <span>üí∞ Income by Category</span>
          </div>
          <div class="report-card-body">
            <div *ngIf="incomeCategories(report.financial.categoryBreakdown).length === 0"
                 class="empty-state">No income transactions this period.</div>
            <div *ngFor="let cat of incomeCategories(report.financial.categoryBreakdown)"
                 class="category-row">
              <div class="category-name">{{ cat.categoryName }}</div>
              <div class="category-bar-wrap">
                <div class="category-bar income-bar"
                     [style.width.%]="barWidth(cat.totalAmount, incomeCategories(report.financial.categoryBreakdown))">
                </div>
              </div>
              <div class="category-amount text-success">
                {{ formatCurrency(cat.totalAmount) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Expense Categories -->
      <div class="col-lg-6">
        <div class="report-card h-100">
          <div class="report-card-header expense-header">
            <span>üì§ Expenses by Category</span>
          </div>
          <div class="report-card-body">
            <div *ngIf="expenseCategories(report.financial.categoryBreakdown).length === 0"
                 class="empty-state">No expense transactions this period.</div>
            <div *ngFor="let cat of expenseCategories(report.financial.categoryBreakdown)"
                 class="category-row">
              <div class="category-name">{{ cat.categoryName }}</div>
              <div class="category-bar-wrap">
                <div class="category-bar expense-bar"
                     [style.width.%]="barWidth(cat.totalAmount, expenseCategories(report.financial.categoryBreakdown))">
                </div>
              </div>
              <div class="category-amount text-danger">
                {{ formatCurrency(cat.totalAmount) }}
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ Invoice Summary Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="row g-3 mb-4">

      <!-- Payment Method Split -->
      <div class="col-lg-4">
        <div class="report-card h-100">
          <div class="report-card-header">
            <span>üí≥ Payment Methods</span>
          </div>
          <div class="report-card-body">
            <div class="payment-split">
              <div class="payment-item">
                <div class="payment-label">Cash</div>
                <div class="payment-bar-wrap">
                  <div class="payment-bar cash-bar"
                       [style.width.%]="report.financial.invoiceSummary.totalInvoiceAmount > 0
                         ? (report.financial.invoiceSummary.cashAmount / report.financial.invoiceSummary.totalInvoiceAmount * 100)
                         : 0">
                  </div>
                </div>
                <div class="payment-amount">{{ formatCurrency(report.financial.invoiceSummary.cashAmount) }}</div>
              </div>
              <div class="payment-item mt-3">
                <div class="payment-label">Other</div>
                <div class="payment-bar-wrap">
                  <div class="payment-bar other-bar"
                       [style.width.%]="report.financial.invoiceSummary.totalInvoiceAmount > 0
                         ? (report.financial.invoiceSummary.otherAmount / report.financial.invoiceSummary.totalInvoiceAmount * 100)
                         : 0">
                  </div>
                </div>
                <div class="payment-amount">{{ formatCurrency(report.financial.invoiceSummary.otherAmount) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Invoices Table -->
      <div class="col-lg-8">
        <div class="report-card h-100">
          <div class="report-card-header">
            <span>üßæ Top 10 Invoices</span>
          </div>
          <div class="report-card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm report-table mb-0">
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>Service</th>
                    <th>Doctor</th>
                    <th>Method</th>
                    <th class="text-end">Amount</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let inv of report.financial.invoiceSummary.topInvoices">
                    <td>{{ inv.patientName }}</td>
                    <td>{{ inv.serviceName }}</td>
                    <td>{{ inv.doctorName }}</td>
                    <td><span class="badge-method">{{ inv.paymentMethod }}</span></td>
                    <td class="text-end fw-semibold">{{ formatCurrency(inv.amount) }}</td>
                    <td class="text-muted small">{{ formatDate(inv.date) }}</td>
                  </tr>
                  <tr *ngIf="report.financial.invoiceSummary.topInvoices.length === 0">
                    <td colspan="6" class="text-center text-muted py-3">No invoices this period.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ Doctor Activity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="row g-3 mb-4">

      <!-- Summary KPIs -->
      <div class="col-lg-3">
        <div class="report-card h-100">
          <div class="report-card-header">
            <span>üë®‚Äç‚öïÔ∏è Doctor Overview</span>
          </div>
          <div class="report-card-body d-flex flex-column gap-3">
            <div class="doctor-kpi">
              <div class="doctor-kpi-label">Active Doctors</div>
              <div class="doctor-kpi-value">{{ report.doctorActivity.totalActiveDoctors }}</div>
            </div>
            <div class="doctor-kpi">
              <div class="doctor-kpi-label">Total Appointments</div>
              <div class="doctor-kpi-value">{{ report.doctorActivity.totalAppointments }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Doctor Performance Bars -->
      <div class="col-lg-9">
        <div class="report-card h-100">
          <div class="report-card-header">
            <span>üìã Doctor Performance</span>
          </div>
          <div class="report-card-body">
            <div *ngIf="report.doctorActivity.doctors.length === 0" class="empty-state">
              No doctor activity this period.
            </div>
            <div *ngFor="let doc of report.doctorActivity.doctors" class="doctor-row">
              <div class="doctor-info">
                <div class="doctor-name">{{ doc.name }}</div>
                <div class="doctor-meta">
                  {{ doc.specialization }}
                  <span class="dept-tags">
                    <span *ngFor="let dept of doc.departments" class="dept-tag">{{ dept }}</span>
                  </span>
                </div>
              </div>
              <div class="doctor-stats">
                <div class="doctor-bar-wrap">
                  <div class="doctor-bar"
                       [style.width.%]="doctorBarWidth(doc.appointmentCount)">
                  </div>
                </div>
                <div class="doctor-numbers">
                  <span class="appt-count">{{ doc.appointmentCount }} appts</span>
                  <span class="rev-pct">{{ doc.revenuePercentage }}%</span>
                  <span class="rev-contrib">{{ formatCurrency(doc.revenueContribution) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </ng-container>
  <!-- end *ngIf report -->

</div>